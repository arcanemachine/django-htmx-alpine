!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Spruce=t()}(this,(function(){function e(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function t(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,s)}return r}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var r=function(e){var t={exports:{}};return e(t,t.exports),t.exports}((function(e,t){e.exports=function(){var e=/^v?(?:\d+)(\.(?:[x*]|\d+)(\.(?:[x*]|\d+)(\.(?:[x*]|\d+))?(?:-[\da-z\-]+(?:\.[\da-z\-]+)*)?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i;function t(e,t){return-1===e.indexOf(t)?e.length:e.indexOf(t)}function r(e){var r=e.replace(/^v/,"").replace(/\+.*$/,""),s=t(r,"-"),i=r.substring(0,s).split(".");return i.push(r.substring(s+1)),i}function s(e){return isNaN(Number(e))?e:Number(e)}function i(t){if("string"!=typeof t)throw new TypeError("Invalid argument expected string");if(!e.test(t))throw new Error("Invalid argument not valid semver ('"+t+"' received)")}function n(e,t){[e,t].forEach(i);for(var n=r(e),a=r(t),o=0;o<Math.max(n.length-1,a.length-1);o++){var c=parseInt(n[o]||0,10),h=parseInt(a[o]||0,10);if(c>h)return 1;if(h>c)return-1}var u=n[n.length-1],d=a[a.length-1];if(u&&d){var l=u.split(".").map(s),p=d.split(".").map(s);for(o=0;o<Math.max(l.length,p.length);o++){if(void 0===l[o]||"string"==typeof p[o]&&"number"==typeof l[o])return-1;if(void 0===p[o]||"string"==typeof l[o]&&"number"==typeof p[o])return 1;if(l[o]>p[o])return 1;if(p[o]>l[o])return-1}}else if(u||d)return u?-1:1;return 0}var a=[">",">=","=","<","<="],o={">":[1],">=":[0,1],"=":[0],"<=":[-1,0],"<":[-1]};function c(e){if("string"!=typeof e)throw new TypeError("Invalid operator type, expected string but got "+typeof e);if(-1===a.indexOf(e))throw new TypeError("Invalid operator, expected one of "+a.join("|"))}return n.validate=function(t){return"string"==typeof t&&e.test(t)},n.compare=function(e,t,r){c(r);var s=n(e,t);return o[r].indexOf(s)>-1},n}()}));const s=e=>null==e,i=e=>Object.getPrototypeOf(e)===Object.prototype,n=e=>Array.isArray(e),a=()=>!(!navigator.userAgent.includes("Node.js")&&!navigator.userAgent.includes("jsdom"))||!!window.Alpine&&r.compare(window.Alpine.version,"2.7.0",">="),o=(e,t)=>(Object.entries(e).forEach((([r,a])=>{s(a)||!i(a)&&!n(a)||(e[r]=o(a,t))})),new Proxy(e,{get:(e,r,s)=>t.get(e,r,s),set(e,r,a,c){s(a)||!i(a)&&!n(a)||(a=o(a,t));let h=e[r];return e[r]=a,s(h)||s(h.__watchers)||(e[r].__watchers=h.__watchers),t.set(e,r,e[r],c),!0}})),c={stores:{},persistenceDriver:window.localStorage,persisted:[],persistedDrivers:{},subscribers:[],pendingWatchers:{},disableReactivity:!1,startingCallbacks:[],startedCallbacks:[],hasStarted:!1,start(){this.startingCallbacks.forEach((e=>e())),this.attach(),this.stores=o(this.stores,{get:(e,t,r)=>Object.is(r,this.stores)&&["get","set","toggle","call","clear"].includes(t)?this[t].bind(this):Reflect.get(e,t,r),set:(e,t,r,s)=>{if(!this.disableReactivity){this.updateSubscribers(),this.runWatchers(e,t,r,s),this.disableReactivity=!0;try{this.persisted.forEach(this.updateLocalStorage.bind(this))}catch(e){}this.disableReactivity=!1}}}),this.hasStarted=!0,this.disableReactivity=!0,Object.entries(this.pendingWatchers).forEach((([e,t])=>{t.forEach((t=>this.watch(e,t)))})),this.disableReactivity=!1,this.startedCallbacks.forEach((e=>e()))},starting(e){this.startingCallbacks.push(e)},started(e){this.startedCallbacks.push(e)},attach(){if(!a())throw new Error("[Spruce] You must be using Alpine >= 2.5.0 to use Spruce.");const e=this;window.Alpine.addMagicProperty("store",(t=>(e.subscribe(t),e.stores)))},store(e,t,r=!1){"function"==typeof t&&(t=t());const s=this.isValidDriver(r);if(!0===r||s)try{this.stores[e]=this.retrieveFromLocalStorage(e,(e=>{let t={};return Object.entries(e).filter((([e,t])=>"function"==typeof t)).forEach((([e,r])=>t[e]=r)),t})(t),s?r:void 0),s&&(this.persistedDrivers[e]=r),this.persisted.includes(e)||this.persisted.push(e)}catch(e){}return this.stores[e]||(this.stores[e]=t),this.stores[e]},reset(e,t){void 0!==this.stores[e]&&(this.stores[e]=t)},delete(e,t=!0){return void 0!==this.stores[e]&&(delete this.stores[e],t&&this.updateSubscribers(),!0)},deleteAll(){const e=Object.keys(this.stores).map((e=>this.delete(e,!1)));return this.updateSubscribers(),!e.some((e=>!e))},subscribe(e){return this.subscribers.includes(e)||this.subscribers.push(e),this.stores},updateSubscribers(){this.subscribers.filter((e=>!!e.__x)).forEach((e=>{e.__x.updateElements(e)}))},retrieveFromLocalStorage(e,t={},r){let s=this.persistenceDriver;void 0!==r&&(this.guardAgainstInvalidDrivers(r),s=r);const i=s.getItem("__spruce:"+e);if(!i)return null;let n=JSON.parse(i);return"object"==typeof n&&(n=Object.assign(t,n),delete n.__watchers,delete n.__key_name),n},updateLocalStorage(r){const s=function(r){for(var s=1;s<arguments.length;s++){var i=null!=arguments[s]?arguments[s]:{};s%2?t(Object(i),!0).forEach((function(t){e(r,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(i)):t(Object(i)).forEach((function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(i,e))}))}return r}({},this.store(r));delete s.__watchers,delete s.__key_name;(this.persistedDrivers[r]||this.persistenceDriver).setItem("__spruce:"+r,JSON.stringify(this.store(r)))},get(e,t=this.stores){return e.split(".").reduce(((e,t)=>e[t]),t)},set(e,t,r=this.stores){return n(e)||(e=e.split(".")),1===e.length?r[e[0]]=t:(r[e[0]]||(r[e[0]]={}),this.set(e.slice(1),t,r[e[0]]))},toggle(e){return this.set(e,!this.get(e))},call(e,...t){return this.get(e)(...t)},clear(e){return this.persistenceDriver.removeItem("__spruce:"+e)},watch(e,t){if(!this.hasStarted)return this.pendingWatchers[e]||(this.pendingWatchers[e]=[]),this.pendingWatchers[e].push(t),[()=>this.unwatch(e,t)];const r=e.split("."),a=r.reduce(((e,t)=>{const r=e[t];return s(r)||!i(r)&&!n(r)?e:r}),this.stores),o=Object.is(a,this.get(e))?"__self":r[r.length-1];return a.hasOwnProperty("__watchers")||Object.defineProperty(a,"__watchers",{enumerable:!1,value:new Map,configurable:!0}),a.__watchers.has(o)||a.__watchers.set(o,new Set),a.__watchers.get(o).add(t),[()=>this.unwatch(e,t)]},unwatch(e,t){const r=e.split("."),a=r.reduce(((e,t)=>{const r=e[t];return s(r)||!i(r)&&!n(r)?e:r}),this.stores),o=Object.is(a,this.get(e))?"__self":r[r.length-1],c=a.__watchers;c.has(o)&&c.get(o).delete(t)},watchers(e){const t=e.split("."),r=t.reduce(((e,t)=>{const r=e[t];return s(r)||!i(r)&&!n(r)?e:r}),this.stores),a=Object.is(r,this.get(e))?"__self":t[t.length-1];return r.__watchers?r.__watchers.get(a):{}},runWatchers(e,t,r){e.__watchers&&(e.__watchers.has(t)&&e.__watchers.get(t).forEach((e=>e(r))),e.__watchers.has("__self")&&e.__watchers.get("__self").forEach((e=>e(r,t))))},persistUsing(e){this.persisted.length>0&&console.warn("[Spruce] You have already initialised a persisted store. Changing the driver may cause issues."),this.guardAgainstInvalidDrivers(e),this.persistenceDriver=e},guardAgainstInvalidDrivers(e){if("function"!=typeof e.getItem)throw new Error("[Spruce] The persistence driver must have a `getItem(key)` method.");if("function"!=typeof e.setItem)throw new Error("[Spruce] The persistence driver must have a `setItem(key, value)` method.");if("function"!=typeof e.removeItem)throw new Error("[Spruce] The persistence driver must have a `removeItem(name)` method.")},isValidDriver(e){try{this.guardAgainstInvalidDrivers(e)}catch(e){return!1}return!0}};window.Spruce=c;const h=window.deferLoadingAlpine||function(e){e()};return window.deferLoadingAlpine=function(e){window.Spruce.start(),h(e)},c}));
